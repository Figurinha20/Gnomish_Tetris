<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tétris</title>
</head>

<body>
    <canvas id="tetrisCanvas" width="400px" height="920px" style="border:3px solid orange;">
        Your Browser Doesn't Support This
    </canvas>
</body>

<script>
    const canvas = document.querySelector('#tetrisCanvas');
    const ctx = canvas.getContext("2d");

    let H = canvas.height
    let W = canvas.width

    ctx.strokeStyle = "black"
    ctx.lineWidth = "2"

    let pieceSize = 40

    //Controls
    let rightKey = false;
    let leftKey = false;
    let upKey = false;
    let downKey = false;
    
    //variavel de incremento de this.y que varia com o i ou seja a row
    let row = -pieceSize;
    //a mesma coisa mas para o x a col
    let col = -pieceSize;

    timer = 0


    class Tetronimo {
        constructor() {
            this.randomTetronimo = Math.floor(Math.random() * 7);
            this.y = 0;
            this.fallingMovement = 40;
            this.x = W / 2;
            this.moving = true;
            this.placement = []
            this.color = "black"
            this.rotation = 0
        }

        createTetronimo() {
            switch (this.randomTetronimo) {
                case 0:
                    //Peça 4x4
                    this.color = "#f6d009"
                    this.placement = [
                        [1, 1],
                        [1, 1]
                    ]
                    break;

                case 1:
                    //Peça FINALLY
                    this.color = "#199ce6"
                    this.placement = [
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0]
                    ]
                    break;

                case 2:
                    //Peça S
                    this.color = "#e91680"
                    this.placement = [
                        [0, 1, 1],
                        [1, 1, 0],
                        [0, 0, 0]
                    ]
                    break;

                case 3:
                    //Peça Z
                    this.color = "#16e97f"
                    this.placement = [
                        [1, 1, 0],
                        [0, 1, 1],
                        [0, 0, 0]
                    ]
                    break;
                case 4:
                    //Peça L
                    this.color = "#E21D29"
                    this.placement = [
                        [0, 1, 0],
                        [0, 1, 0],
                        [0, 1, 1]
                    ]
                    break;
                case 5:
                    //Peça J
                    this.color = "#1DE2D6"
                    this.placement = [
                        [0, 1, 0],
                        [0, 1, 0],
                        [1, 1, 0]
                    ]
                    break;
                case 6:
                    //Peça T
                    this.color = "#A711EE"
                    this.placement = [
                        [0, 0, 0],
                        [1, 1, 1],
                        [0, 1, 0]
                    ]
                    break;
                default:
                    alert("oi?")
                    break;
            }
        }

        draw() {

            ctx.fillStyle = this.color
            //this.x & this.y é o centro do array bidimensional

            col = -pieceSize
            row = -pieceSize

            for (let i = 0; i < this.placement.length; i++) {

                for (let j = 0; j < this.placement[i].length; j++) {
                    //check if draw
                    if (this.placement[i][j] == 1) {
                        ctx.fillRect(this.x + col, this.y + row, pieceSize, pieceSize)
                        ctx.strokeRect(this.x + col, this.y + row, pieceSize, pieceSize)
                    }
                    //mudança de col
                    col += pieceSize
                }

                //mudança de row
                row += pieceSize
                //reset da col
                col = -pieceSize
            }
        }


        rotate() {
            //vou rodar as cenas à la pate
            if (this.color == "#f6d009") {
                //Do absolutely nothing, it's the square piece
            } else if (this.color == "#199ce6") {
                if (this.rotation == 0) {
                    this.placement = [
                        [0, 0, 0, 0],
                        [1, 1, 1, 1],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 1) {
                    this.placement = [
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0]
                    ]
                    this.rotation = 0
                }

            } else if (this.color == "#e91680") {
                if (this.rotation == 0) {
                    this.placement = [
                        [0, 1, 0],
                        [0, 1, 1],
                        [0, 0, 1]
                    ]
                    this.rotation++
                } else if (this.rotation == 1) {
                    this.placement = [
                        [0, 1, 1],
                        [1, 1, 0],
                        [0, 0, 0]
                    ]
                    this.rotation = 0
                }
            } else if (this.color == "#16e97f") {
                if (this.rotation == 0) {
                    this.placement = [
                        [0, 1, 0],
                        [1, 1, 0],
                        [1, 0, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 1) {
                    this.placement = [
                        [1, 1, 0],
                        [0, 1, 1],
                        [0, 0, 0]
                    ]
                    this.rotation = 0
                }

            } else if (this.color == "#E21D29") {
                if (this.rotation == 0) {
                    this.placement = [
                        [0, 0, 0],
                        [1, 1, 1],
                        [1, 0, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 1) {
                    this.placement = [
                        [1, 1, 0],
                        [0, 1, 0],
                        [0, 1, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 2) {
                    this.placement = [
                        [0, 0, 1],
                        [1, 1, 1],
                        [0, 0, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 3) {
                    this.placement = [
                        [0, 1, 0],
                        [0, 1, 0],
                        [0, 1, 1]
                    ]
                    this.rotation = 0
                }
            } else if (this.color == "#1DE2D6") {
                if (this.rotation == 0) {
                    this.placement = [
                        [1, 0, 0],
                        [1, 1, 1],
                        [0, 0, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 1) {
                    this.placement = [
                        [0, 1, 1],
                        [0, 1, 0],
                        [0, 1, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 2) {
                    this.placement = [
                        [0, 0, 0],
                        [1, 1, 1],
                        [0, 0, 1]
                    ]
                    this.rotation++
                } else if (this.rotation == 3) {
                    this.placement = [
                        [0, 1, 0],
                        [0, 1, 0],
                        [1, 1, 0]
                    ]
                    this.rotation = 0
                }
            } else if (this.color == "#A711EE") {
                if (this.rotation == 0) {
                    this.placement = [
                        [0, 1, 0],
                        [0, 1, 1],
                        [0, 1, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 1) {
                    this.placement = [
                        [0, 0, 0],
                        [1, 1, 1],
                        [0, 1, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 2) {
                    this.placement = [
                        [0, 1, 0],
                        [1, 1, 0],
                        [0, 1, 0]
                    ]
                    this.rotation++
                } else if (this.rotation == 3) {
                    this.placement = [
                        [0, 1, 0],
                        [1, 1, 1],
                        [0, 0, 0]
                    ]
                    this.rotation = 0
                }
            }
        }


        update() {
            //this.x & this.y é o centro do array bidimensional
            
            col = -pieceSize
            row = -pieceSize

            for (let i = 0; i < this.placement.length; i++) {

                for (let j = 0; j < this.placement[i].length; j++) {
                    //check if draw
                    if (this.placement[i][j] == 1) {
                        if (this.x + col < 0) {
                            this.x += pieceSize
                        }
                        if (this.x + col >= W) {
                            this.x -= pieceSize
                        }

                        if (this.y + row > H - pieceSize) {
                            this.moving = false;
                            this.y -= pieceSize;
                        }

                    }
                    //mudança de col
                    col += pieceSize
                }

                //mudança de row
                row += pieceSize
                //reset da col
                col = -pieceSize
            }


            if(this.moving == true){
                console.log(timer);
                timer++

                if (timer > 9) {
                this.y += this.fallingMovement
                timer = 0
            }
            }
            
            

        }

    }

    let gameArray = new Array()
    gameArray.push(new Tetronimo())
    gameArray[gameArray.length - 1].createTetronimo();
    console.log(gameArray[gameArray.length - 1])

    function render() {
        //clear canvas
        ctx.fillStyle = "rgba(255, 255, 255)"
        ctx.fillRect(0, 0, W, H)

        //draw GRID
        for (var x = 0; x < W; x += 40) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, H);
        }

        for (var y = 0; y < H; y += 40) {
            ctx.moveTo(0, y);
            ctx.lineTo(W, y);
        }

        ctx.strokeStyle = "#FCE3BF";
        ctx.stroke();

        //sets handlers for events keydown & keyup
        window.addEventListener('keydown', ArrowPressed);
        window.addEventListener('keyup', ArrowReleased);

        //draw & update
        gameArray.forEach(function (tetronimo) {

            if (rightKey == true && tetronimo.moving) {
                tetronimo.x += 40
            }
            if (leftKey && tetronimo.moving) {
                tetronimo.x -= 40
            }
            if (upKey && tetronimo.moving) {
                tetronimo.rotate();
                upKey = false;
            }

            //tetronimo.createTetronimo();
            tetronimo.update();
            tetronimo.draw();
        });


        
        if (gameArray[gameArray.length - 1].moving == false) {
            gameArray.push(new Tetronimo())
            gameArray[gameArray.length - 1].createTetronimo();
            console.log(gameArray[gameArray.length - 1].moving)
        }

    }

    setInterval(render, 95);



    //handler for keydown
    function ArrowPressed(e) {
        if (e.key == 'ArrowRight') {
            rightKey = true; //Canvas#2
        }

        if (e.key == 'ArrowLeft') {
            leftKey = true; //Canvas#2
        }

        if (e.key == 'ArrowUp' && e.repeat == false) {
            upKey = true; //Canvas#2
        }

        if (e.key == 'ArrowDown') {
            downKey = true; //Canvas#2
        }

    }


    //handler for keyup
    function ArrowReleased(e) {
        if (e.key == 'ArrowRight') {
            rightKey = false; //Canvas#2
        }

        if (e.key == 'ArrowLeft') {
            leftKey = false; //Canvas#2
        }

        if (e.key == 'ArrowUp') {
            upKey = false; //Canvas#2
        }

        if (e.key == 'ArrowDown') {
            downKey = false; //Canvas#2
        }
    }
</script>

</html>